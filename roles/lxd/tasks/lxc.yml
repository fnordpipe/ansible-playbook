---
# comment

- name: create /var/lib/lxc/{{ lxcItem.split('.')[0] }}/rootfs
  file:
    dest: /var/lib/lxc/{{ lxcItem.split('.')[0] }}/rootfs
    state: directory

- name: copy lxc config of {{ lxcItem }}
  template:
    src: etc/lxc/gentoo-overlay.config.j2
    dest: "/etc/lxc/config/{{ lxcItem.split('.')[0] }}.config"
    owner: root
    group: root
    mode: 0600

- name: create container {{ lxcItem }}
  lxc_container:
    name: "{{ lxcItem.split('.')[0] }}"
    config: "/etc/lxc/config/{{ lxcItem.split('.')[0] }}.config"
    directory: "/var/lib/lxc/{{ lxcItem.split('.')[0] }}/rootfs"
    container_command: /sbin/init
    container_log: True
    template: fnordpipe-overlay
    template_options: "--iface={{ lxcInterface }} --iaddr={{ hostvars[lxcItem]['hostConfig']['network']['interfaces'][lxcInterface]['ipv4addr'] | default('dhcp') }} --route={{ hostvars[lxcItem]['hostConfig']['network']['interfaces'][lxcInterface]['ipv4route'] | default('default') }}"
    state: started
  vars:
    - lxcInterface: "{{ hostvars[lxcItem]['hostConfig']['network']['default'] | default('eth0') }}"

- name: link initscript of {{ lxcItem }}
  file:
    src: /etc/init.d/lxc
    dest: "/etc/init.d/lxc.{{ lxcItem.split('.')[0] }}"
    state: link

- name: link initscript of {{ lxcItem }} to runlevel
  file:
    src: "/etc/init.d/lxc.{{ lxcItem.split('.')[0] }}"
    dest: "/etc/runlevels/default/lxc.{{ lxcItem.split('.')[0] }}"
    force: True
    state: link

- name: check config of {{ lxcItem }}
  lineinfile:
    dest: /var/lib/lxc/{{ lxcItem.split('.')[0] }}/config
    regexp: "{{ item.regex }}"
    line: "{{ item.line }}"
  vars:
    lxcMac: "{{ genericConfig['macprefix'] | default('de:ad:be:ef') }}:{{ lxcItem | hash('md5') | regex_replace('^([0-9a-f]{2}).*([0-9a-f]{2})$', '\\1:\\2') }}"
  with_items:
    - { regex: '^lxc.network.hwaddr =.*', line: "lxc.network.hwaddr = {{ lxcMac }}" }
    - { regex: '^lxc.network.link =.*', line: "lxc.network.link = {{ hostvars[lxcItem]['lxcConfig']['bridge'] | default('br0') }}" }
    - { regex: '^lxc.utsname =.*', line: "lxc.utsname = {{ lxcItem.split('.')[0] }}" }
    - { regex: '^lxc.rootfs =.*', line: "lxc.rootfs = /var/lib/lxc/{{ lxcItem.split('.')[0]}}/rootfs" }
