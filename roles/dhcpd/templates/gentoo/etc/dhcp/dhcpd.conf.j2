# dhcp config
authoritative;

subnet {{ dhcpdConfig['subnetId'] | default('10.255.255.0') }} netmask {{ dhcpdConfig['netmask'] | default('255.255.255.0') }} {
  range {{ dhcpdConfig['rangeStart'] | default('10.255.255.20') }} {{ dhcpdConfig['rangeEnd'] | default('10.255.255.254') }};
  default-lease-time {{ dhcpdConfig['lease'] | default('86400') }};

  option routers {{ dhcpdConfig['defaultRoute'] | default('10.255.255.1') }};
  option domain-name "{{ dhcpdConfig['domainName'] | default('example.org') }}";
  option domain-name-servers {{ dhcpdConfig['dnsServers'] | default('85.214.20.141') }};

  on commit {
    execute(
      "/usr/libexec/dhcp/hooks/ansible.py",
      binary-to-ascii(16, 8, ":", substring(hardware, 1, 6)),
      binary-to-ascii(10, 8, ".", leased-address),
      pick-first-value(option host-name, "none"),
      "{{ dhcpdConfig['domainName'] | default('example.org') }}");
  }

{% for host in groups['all'] %}
{% if hostvars[host]['ansible_default_ipv4'] is defined %}
  host {{ host.split('.')[0] }} {
    hardware ethernet {{ hostvars[host]['ansible_default_ipv4']['macaddress'] }};
    fixed-address {{ hostvars[host]['ansible_default_ipv4']['address'] }};
  }
{% endif %}
{% endfor %}
}
