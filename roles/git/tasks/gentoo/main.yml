---
- name: install packages
  portage:
    name: "{{ item }}"
    quiet: yes
    getbinpkg: yes
  with_items:
    - dev-vcs/git
    - www-misc/fcgiwrap
    - www-servers/spawn-fcgi
    - www-apps/cgit

- name: check config
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  with_items:
    - { src: generic/etc/nginx/conf.d/cgit.conf.j2, dest: /etc/nginx/conf.d/cgit.conf, owner: root, group: root, mode: 644 }
    - { src: gentoo/etc/conf.d/spawn-fcgi.j2, dest: /etc/conf.d/spawn-fcgi.cgit, owner: root, group: root, mode: 644 }
    - { src: generic/etc/cgitrc.j2, dest: /etc/cgitrc, owner: root, group: root, mode: 644 }
  notify:
    - restart webserver

- name: set initscript symlink
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
  with_items:
    - { src: spawn-fcgi, dest: /etc/init.d/spawn-fcgi.cgit }
    - { src: /etc/init.d/spawn-fcgi.cgit, dest: /etc/runlevels/default/spawn-fcgi.cgit }

- name: check user
  user:
    createhome: yes
    home: /var/lib/git
    name: git
    shell: /usr/bin/git-shell
    state: present

- name: start http service
  service:
    name: "{{ item }}"
    state: started
  with_items:
    - spawn-fcgi.cgit

- name: update authorized_keys
  authorized_key:
    user: git
    key: "{{ item }}"
    state: present
  with_items: "{{ hostvars[inventory_hostname]['gitConfig']['sshPubKeys'] | default([]) }}"

- name: update git categories
  file:
    dest: "/var/lib/git/{{ item.category }}"
    owner: git
    group: git
    mode: 0755
    state: directory
  with_items: "{{ hostvars[inventory_hostname]['gitConfig']['repos'] | default([]) }}"

- name: update repositories
  command: "git init --bare /var/lib/git/{{ item.category }}/{{ item.name }}.git"
  args:
    chdir: /var/lib/git
    creates: "/var/lib/git/{{ item.category }}/{{ item.name }}.git"
  with_items: "{{ hostvars[inventory_hostname]['gitConfig']['repos'] | default([]) }}"

- name: update repo config
  template:
    src: generic/var/lib/git/cgitrc.j2
    dest: "/var/lib/git/{{ item.category }}/{{ item.name }}.git/cgitrc"
    owner: git
    group: git
    mode: 0644
  with_items: "{{ hostvars[inventory_hostname]['gitConfig']['repos'] | default([]) }}"

- name: update permissions
  file:
    dest: "/var/lib/git/{{ item.category }}"
    owner: git
    group: git
    recurse: yes
  with_items: "{{ hostvars[inventory_hostname]['gitConfig']['repos'] | default([]) }}"
